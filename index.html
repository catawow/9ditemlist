<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Craft Planner ‚Äì Resource/Crate/Trade & NPC</title>
<meta name="color-scheme" content="dark light">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ†Ô∏è</text></svg>">
<style>
:root {
  --bg:#0b0f14; --panel:#121821; --muted:#9fb0c0; --text:#e6eef7;
  --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#f87171;
  --focus: 0 0 0 3px rgba(96,165,250,.55);
}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0f14 0%,#111827 100%);color:var(--text)}
header{display:flex;flex-direction:column;gap:8px;padding:16px 20px;position:sticky;top:0;background:rgba(11,15,20,.8);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:10}
header .topbar{display:flex;align-items:center;gap:12px}
header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
.badge{padding:4px 8px;border:1px solid rgba(255,255,255,.1);border-radius:999px;font-size:12px;color:var(--muted)}
#searchGlobal{background:#0c1220;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;font-size:14px;width:100%;max-width:420px}
#searchGlobal:focus{box-shadow:var(--focus)}
.countBadge{margin-left:6px;padding:2px 6px;background:rgba(255,255,255,.1);border-radius:999px;font-size:12px;cursor:pointer}
.btn.small{font-size:12px;padding:8px 10px}
main{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.section{padding:16px}
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0c1220;cursor:pointer}
.tab.active{background:var(--accent);color:#00132a;font-weight:700;border-color:transparent}
select,input,button{background:#0c1220;color:#e6eef7;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
input:focus,select:focus,button:focus{box-shadow:var(--focus)}
button{cursor:pointer}
button.primary{background:var(--accent);border:none;color:#00132a;font-weight:700}
.row{display:flex;gap:10px;align-items:center}
.col{display:flex;flex-direction:column;gap:10px}
.title{font-size:12px;color:var(--muted)}
.list{display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow:auto;scroll-margin-top:90px}
.item{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid rgba(255,255,255,.06);background:#0e1526;border-radius:12px}
.item-title{flex:1}
.item-img{width:40px;height:40px;object-fit:contain;border-radius:8px}
.muted{color:var(--muted)}
.tree{padding:16px;max-height:75vh;overflow:auto}
.node>.label{display:inline-flex;align-items:center;gap:8px;background:#0e1526;border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:10px}
.qty{font-variant-numeric:tabular-nums;color:#b6f1d3}
.chance{color:var(--warn)}
details{margin-left:18px}
.footer{padding:10px 16px;border-top:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:6px;background:#0e1526;border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;font-size:12px}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.toolbar{display:flex;gap:8px;align-items:center}
.overlay-panel{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:60}
.overlay-panel.open{display:flex}
.overlay-content{background:var(--panel);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:20px;max-width:520px;width:90%;max-height:80vh;overflow:auto;box-shadow:0 10px 40px rgba(0,0,0,.5)}
.overlay-content h3{margin-top:0;margin-bottom:12px;font-size:16px;text-align:center}
.overlay-content .variant-btn{display:flex;flex-direction:column;gap:6px}
.img-wrap{display:flex;justify-content:center}
.img-wrap img{max-width:100%;height:auto;border-radius:12px;border:1px solid rgba(255,255,255,.08)}
hr.sep{border:none;border-top:1px dashed rgba(255,255,255,.12);margin:6px 0}
.empty{border:1px dashed rgba(255,255,255,.15);border-radius:12px;padding:10px;text-align:center;color:var(--muted)}
@media (max-width: 960px){
  main{grid-template-columns:1fr}
}
/* NEW: accesibilitate, visually hidden */
.sr-only{
  position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}
/* NEW: clasa .btn reutilizabilƒÉ */
.btn{background:#0c1220;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;font-size:14px;display:inline-flex;align-items:center;gap:6px}
.btn:focus{box-shadow:var(--focus)}
#searchSuggestions{
  position:absolute;
  background:#0e1526;
  border:1px solid rgba(255,255,255,.1);
  border-radius:10px;
  margin-top:4px;
  padding:4px 0;
  width:100%;
  max-width:420px;
  max-height:220px;
  overflow:auto;
  z-index:20;
  display:none;
}
#searchSuggestions .suggest-item{ padding:8px 12px; cursor:pointer; }
#searchSuggestions .suggest-item:hover,
#searchSuggestions .suggest-item.active{ background:rgba(255,255,255,.1); }

/* ===== Tooltip surse ===== */
.tooltip{
  position:fixed;
  display:none;
  z-index:120;
  background:#0e1526;
  border:1px solid rgba(255,255,255,.12);
  border-radius:10px;
  padding:8px 10px;
  font-size:12px;
  color:var(--text);
  max-width:340px;
  box-shadow:0 10px 25px rgba(0,0,0,.35);
  pointer-events:none;
  white-space:nowrap;
}
.tooltip .line{
  display:flex;
  gap:6px;
  align-items:center;
}
.tooltip .line:not(:last-child){
  margin-bottom:4px;
}
.has-tip{
  text-decoration-style:dotted;
  text-decoration-color:rgba(255,255,255,.25);
}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <h1 id="appTitle" aria-label="Titlu aplica»õie" data-i18n="appTitle">Arbore de Crafting</h1>
    <span class="badge" aria-label="Moduri" data-i18n="modeBadge">Mod Resource / Crate / Trade ‚Ä¢ Map ‚Ä¢ NPC</span>

    <!-- Selector de limbƒÉ -->
    <select id="langSelect" aria-label="Language">
      <option value="ro">RO</option>
      <option value="en">EN</option>
    </select>

    <div style="flex:1"></div>
    <button id="openList" class="btn small" type="button" data-i18n-title="btn_open_list_title">
      <span data-i18n="btnList">ListƒÉ</span>
      <span id="listCount" class="countBadge" aria-live="polite" tabindex="0" data-i18n-title="btn_open_list_title" title="Deschide lista">0</span>
    </button>
    <button id="copyLink" class="btn" type="button" data-i18n="btnCopyLink" data-i18n-title="btn_copy_link_title" title="CopiazƒÉ link cu starea curentƒÉ">CopiazƒÉ link</button>
    <button id="resetState" class="btn" type="button" data-i18n="btnReset">Reset</button>
  </div>
  <label class="sr-only" for="searchGlobal" data-i18n="searchGlobalLabel">CƒÉutare globalƒÉ</label>
  <div style="position:relative;max-width:420px;width:100%;">
    <input id="searchGlobal" data-i18n-placeholder="searchGlobalPlaceholder" placeholder="TasteazƒÉ un nume de item »ôi apasƒÉ Enter‚Ä¶ (ex: Ultimate Tablet)" />
    <div id="searchSuggestions"></div>
  </div>
</header>

<main>
<section class="card section" aria-label="Filtre »ôi listƒÉ NPC">
  <div class="tabs" id="tabs" role="tablist"></div>
  <div class="col">
    <label class="title" for="mapSelect" data-i18n="labelMap">Map</label>
    <select id="mapSelect" aria-label="Alege harta"></select>
    <label class="title" for="npcSelect" data-i18n="labelNpc">NPC</label>
    <select id="npcSelect" aria-label="Alege NPC"></select>
    <div class="row">
      <input id="searchInput" data-i18n-placeholder="searchNpcPlaceholder" placeholder="CautƒÉ item la NPC..." style="flex:1" aria-label="CautƒÉ item la NPC" />
      <input id="qtyInput" type="number" value="1" min="1" step="1" style="width:100px" aria-label="Cantitate" />
    </div>
    <div class="title" style="margin-top:6px" data-i18n="npcItemsTitle">Iteme oferite de NPC</div>
    <div id="npcItems" class="list" tabindex="-1"></div>
  </div>
</section>

<section class="card" aria-label="Arbore re»õetƒÉ">
  <div class="toolbar" style="padding:10px 16px;border-bottom:1px solid rgba(255,255,255,.06)">
    <h2 style="margin:0;font-size:14px;font-weight:600" data-i18n="recipeHeaderTitle">Re»õetƒÉ</h2>
    <span class="pill" id="currentItemName">‚Äî</span>
    <div style="flex:1"></div>
    <button id="expandAll" type="button" data-i18n="btnExpandAll">Extinde tot</button>
    <button id="collapseAll" type="button" data-i18n="btnCollapseAll">Restr√¢nge tot</button>
    <button id="addToList" type="button" data-i18n="btnAddToList" data-i18n-title="btn_add_to_list_title" title="AdaugƒÉ itemul curent √Æn listƒÉ">AdaugƒÉ la listƒÉ</button>
    <button id="exportJson" type="button" data-i18n="btnExportJson" data-i18n-title="btn_export_tree_title" title="CopiazƒÉ structura arborelui √Æn format JSON">Export JSON</button>
  </div>
  <div class="tree" id="tree"><div class="empty" data-i18n="treeEmpty">Alege un item din st√¢nga sau cautƒÉ mai sus</div></div>
  <div class="footer">
    <div class="muted" data-i18n="footerNote">Nodurile fƒÉrƒÉ re»õetƒÉ sunt materiale de bazƒÉ.</div>
    <div id="meta" class="pills" aria-live="polite"></div>
  </div>
</section>
</main>

<!-- Overlay: Alege re»õeta -->
<div id="variantOverlay" class="overlay-panel" aria-modal="true" role="dialog" aria-labelledby="variantTitle">
  <div class="overlay-content">
    <h3 id="variantTitle" data-i18n="overlayVariantTitle">Alege re»õeta</h3>
    <div id="variantList" class="variant-btn"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="closeVariantOverlay" class="btn" type="button" data-i18n="btnClose">√énchide</button>
    </div>
  </div>
</div>

<!-- Overlay: Lista -->
<div id="listOverlay" class="overlay-panel" aria-modal="true" role="dialog" aria-labelledby="listTitle">
  <div class="overlay-content">
    <h3 id="listTitle" data-i18n="overlayListTitle">Lista mea</h3>
    <div id="listBody" class="list" style="max-height:50vh"></div>
    <div style="display:flex; gap:8px; justify-content:center; margin-top:12px">
      <button id="exportList" class="btn" type="button" data-i18n="btnExportList" data-i18n-title="btn_export_list_title" title="CopiazƒÉ lista ca JSON">ExportƒÉ JSON</button>
      <button id="clearList" class="btn" type="button" data-i18n="btnClearList" data-i18n-title="btn_clear_list_title" title="Gole»ôte lista">Gole»ôte</button>
      <button id="closeListOverlay" class="btn" type="button" data-i18n="btnClose">√énchide</button>
    </div>
  </div>
</div>

<!-- Overlay: UtilizƒÉri item -->
<div id="usesOverlay" class="overlay-panel" aria-modal="true" role="dialog" aria-labelledby="usesTitle">
  <div class="overlay-content">
    <h3 id="usesTitle" data-i18n="overlayUsesTitle">UtilizƒÉri pentru item</h3>
    <div id="usesBody" class="list" style="max-height:50vh"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="closeUsesOverlay" class="btn" type="button" data-i18n="btnClose">√énchide</button>
    </div>
  </div>
</div>

<!-- Overlay: Imagine detalii -->
<div id="imageOverlay" class="overlay-panel" aria-modal="true" role="dialog" aria-labelledby="imageTitle">
  <div class="overlay-content">
    <h3 id="imageTitle">Detalii item</h3>
    <div class="img-wrap"><img id="imageOverlayImg" alt="Detalii item"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="closeImageOverlay" class="btn" type="button" data-i18n="btnClose">√énchide</button>
    </div>
  </div>
</div>

<!-- 1) √éncarcƒÉ datele √Ænainte de logica aplica»õiei -->
<script src="data.js"></script>

<!-- 2) Script principal -->
<script>
/* ===== Utilitare ===== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const fmtQty=n=>new Intl.NumberFormat('ro-RO').format(n);

/* ===== I18N (RO / EN) ===== */
let currentLang = localStorage.getItem('lang') || 'ro';

const I18N = {
  ro: {
    appTitle: 'Arbore de Crafting',
    modeBadge: 'Mod Resource / Crate / Trade ‚Ä¢ Map ‚Ä¢ NPC',
    btnList: 'ListƒÉ',
    btnCopyLink: 'CopiazƒÉ link',
    btnReset: 'Reset',
    searchGlobalLabel: 'CƒÉutare globalƒÉ',
    searchGlobalPlaceholder: 'TasteazƒÉ un nume de item »ôi apasƒÉ Enter‚Ä¶ (ex: Ultimate Tablet)',
    labelMap: 'Map',
    labelNpc: 'NPC',
    searchNpcPlaceholder: 'CautƒÉ item la NPC...',
    npcItemsTitle: 'Iteme oferite de NPC',
    recipeHeaderTitle: 'Re»õetƒÉ',
    btnExpandAll: 'Extinde tot',
    btnCollapseAll: 'Restr√¢nge tot',
    btnAddToList: 'AdaugƒÉ la listƒÉ',
    btnExportJson: 'Export JSON',
    treeEmpty: 'Alege un item din st√¢nga sau cautƒÉ mai sus',
    footerNote: 'Nodurile fƒÉrƒÉ re»õetƒÉ sunt materiale de bazƒÉ.',
    overlayVariantTitle: 'Alege re»õeta',
    overlayVariantTitleFor: 'Alege re»õeta pentru "{item}"',
    overlayListTitle: 'Lista mea',
    overlayUsesTitle: 'UtilizƒÉri pentru item',
    btnClose: '√énchide',
    btnExportList: 'ExportƒÉ JSON',
    btnClearList: 'Gole»ôte',
    copy_success: 'Copiat √Æn clipboard!',
    copy_error: 'Nu s-a putut copia.',
    search_not_found: 'Itemul nu a fost gƒÉsit √Æn DATA.',
    no_items_current_selection: 'Niciun item pentru selec»õia curentƒÉ.',
    select_item_first: 'SelecteazƒÉ √Ænt√¢i un item.',
    added_to_list: 'AdƒÉugat √Æn listƒÉ',
    list_empty: 'Lista este goalƒÉ.',
    btn_see_recipe: 'Vezi re»õeta',
    btn_uses: 'Ce pot face?',
    btn_add: 'AdaugƒÉ',
    uses_title: 'Ce po»õi face din "{name}"',
    uses_none: 'Acest item nu este folosit ca ingredient √Æn nicio re»õetƒÉ.',
    uses_consumes: 'ConsumƒÉ: √ó{qty} din {name}',
    btn_choose: 'Alege',
    btn_delete: '»òterge',
    toast_selected_from_list: 'Selectat din listƒÉ',
    list_qty_label: 'Cantitate: √ó{qty}',
    list_btn_minus_title: 'Scade 1',
    list_btn_plus_title: 'AdaugƒÉ 1',
    list_btn_choose_title: 'AratƒÉ re»õeta pentru acest item',
    list_btn_delete_title: '»òterge din listƒÉ',
    badge_base_material: 'Material de bazƒÉ (fƒÉrƒÉ re»õetƒÉ)',
    btn_open_list_title: 'Deschide lista',
    btn_copy_link_title: 'CopiazƒÉ link cu starea curentƒÉ',
    btn_add_to_list_title: 'AdaugƒÉ itemul curent √Æn listƒÉ',
    btn_export_tree_title: 'CopiazƒÉ structura arborelui √Æn format JSON',
    btn_export_list_title: 'CopiazƒÉ lista ca JSON',
    btn_clear_list_title: 'Gole»ôte lista',
    selected_variant: 'VariantƒÉ selectatƒÉ',
    meta_nodes: 'Noduri'
  },
  en: {
    appTitle: 'Crafting Tree',
    modeBadge: 'Mode Resource / Crate / Trade ‚Ä¢ Map ‚Ä¢ NPC',
    btnList: 'List',
    btnCopyLink: 'Copy link',
    btnReset: 'Reset',
    searchGlobalLabel: 'Global search',
    searchGlobalPlaceholder: 'Type an item name and press Enter‚Ä¶ (e.g. Ultimate Tablet)',
    labelMap: 'Map',
    labelNpc: 'NPC',
    searchNpcPlaceholder: 'Search item at NPC...',
    npcItemsTitle: 'Items offered by NPC',
    recipeHeaderTitle: 'Recipe',
    btnExpandAll: 'Expand all',
    btnCollapseAll: 'Collapse all',
    btnAddToList: 'Add to list',
    btnExportJson: 'Export JSON',
    treeEmpty: 'Pick an item from the left or search above',
    footerNote: 'Nodes without recipes are base materials.',
    overlayVariantTitle: 'Choose recipe',
    overlayVariantTitleFor: 'Choose recipe for "{item}"',
    overlayListTitle: 'My list',
    overlayUsesTitle: 'Item uses',
    btnClose: 'Close',
    btnExportList: 'Export JSON',
    btnClearList: 'Clear',
    copy_success: 'Copied to clipboard!',
    copy_error: 'Could not copy.',
    search_not_found: 'Item was not found in DATA.',
    no_items_current_selection: 'No items for the current selection.',
    select_item_first: 'Select an item first.',
    added_to_list: 'Added to list',
    list_empty: 'The list is empty.',
    btn_see_recipe: 'Show recipe',
    btn_uses: 'What can I craft?',
    btn_add: 'Add',
    uses_title: 'What you can craft from "{name}"',
    uses_none: 'This item is not used as an ingredient in any recipe.',
    uses_consumes: 'Consumes: √ó{qty} of {name}',
    btn_choose: 'Choose',
    btn_delete: 'Delete',
    toast_selected_from_list: 'Selected from list',
    list_qty_label: 'Quantity: √ó{qty}',
    list_btn_minus_title: 'Decrease by 1',
    list_btn_plus_title: 'Increase by 1',
    list_btn_choose_title: 'Show recipe for this item',
    list_btn_delete_title: 'Remove from list',
    badge_base_material: 'Base material (no recipe)',
    btn_open_list_title: 'Open list',
    btn_copy_link_title: 'Copy link with current state',
    btn_add_to_list_title: 'Add current item to list',
    btn_export_tree_title: 'Copy tree structure as JSON',
    btn_export_list_title: 'Copy list as JSON',
    btn_clear_list_title: 'Clear list',
    selected_variant: 'Selected variant',
    meta_nodes: 'Nodes'
  }
};

function tr(key){
  const lang = (currentLang in I18N) ? currentLang : 'ro';
  return I18N[lang][key] || I18N.ro[key] || key;
}
function trf(key, params){
  let s = tr(key);
  if (!params) return s;
  for (const [k,v] of Object.entries(params)){
    s = s.replace(new RegExp(`\\{${k}\\}`,'g'), v);
  }
  return s;
}

function applyLanguage(lang){
  if (!I18N[lang]) lang = 'ro';
  currentLang = lang;
  document.documentElement.lang = lang;
  localStorage.setItem('lang', lang);

  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.dataset.i18n;
    const txt = tr(key);
    if (txt) el.textContent = txt;
  });

  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
    const key = el.dataset.i18nPlaceholder;
    const txt = tr(key);
    if (txt) el.placeholder = txt;
  });

  document.querySelectorAll('[data-i18n-title]').forEach(el=>{
    const key = el.dataset.i18nTitle;
    const txt = tr(key);
    if (txt) el.title = txt;
  });

  // re-randƒÉm listele, ca sƒÉ se actualizeze textele de pe butoane etc.
  renderNpcItems();
  renderListPanel();
  if (state.currentItem) showRecipe(state.currentItem);
}

const copy = async (t)=>{
  try{
    await navigator.clipboard.writeText(t);
    toast(tr('copy_success'));
  }catch(e){
    toast(tr('copy_error'));
  }
};
const debounce=(fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};

/* ==== Imagini ==== */
const PLACEHOLDER_IMG = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'><rect width='24' height='24' rx='4' fill='%231a2435'/><text x='12' y='17' text-anchor='middle' font-size='12' fill='%239fb0c0'>üéí</text></svg>";
const escapeAttr = (s)=> String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
function getImageForItem(name){
  const rec = DATA[name];
  if(!rec) return PLACEHOLDER_IMG;
  if(rec.image) return rec.image;
  const idx = state.selectedVariant[name] ?? 0;
  const v = rec.variants?.[idx] || rec.variants?.[0];
  if(v?.image) return v.image;
  return PLACEHOLDER_IMG;
}
function getDetailImageForItem(name){
  const rec = DATA[name];
  return rec?.detailImage || getImageForItem(name);
}

/* ===== Tooltip surse ===== */
function sourceLines(name){
  const rec = DATA[name];
  if(!rec?.variants?.length) return [];
  return rec.variants.map(v=>{
    const s = v.success != null ? ` ‚Äî ${v.success}%` : '';
    return `${v.source.tab} ‚Ä¢ ${v.source.map} ‚Ä¢ ${v.source.npc}${s}`;
  });
}
function attachTooltip(el, name){
  if(!el) return;
  const lines = sourceLines(name);
  if(!lines.length) return;
  el.classList.add('has-tip');
  el.setAttribute('data-tip', lines.join('\n'));
  el.setAttribute('title', lines.join(' | ')); // fallback nativ
}
let _tipEl = null;
let _tipVisible = false;
function ensureTip(){
  if(_tipEl) return _tipEl;
  _tipEl = document.createElement('div');
  _tipEl.className = 'tooltip';
  document.body.appendChild(_tipEl);
  return _tipEl;
}
function positionTip(x,y){
  const el = _tipEl;
  if(!el) return;
  const pad = 12;
  const w = el.offsetWidth;
  const h = el.offsetHeight;
  const maxX = window.scrollX + window.innerWidth - w - pad;
  const maxY = window.scrollY + window.innerHeight - h - pad;
  const nx = Math.min(x + pad, maxX);
  const ny = Math.min(y + pad, maxY);
  el.style.left = nx + 'px';
  el.style.top = ny + 'px';
}
function showTip(text,x,y){
  const el = ensureTip();
  el.innerHTML = '';
  text.split('\n').forEach(t=>{
    const d = document.createElement('div');
    d.className = 'line';
    d.textContent = t;
    el.appendChild(d);
  });
  el.style.display = 'block';
  _tipVisible = true;
  positionTip(x,y);
}
function hideTip(){
  if(_tipEl) _tipEl.style.display = 'none';
  _tipVisible = false;
}

document.addEventListener('mouseover', (e)=>{
  const t = e.target.closest('.has-tip');
  if(!t) return;
  const txt = t.getAttribute('data-tip');
  if(!txt) return;
  showTip(txt, e.clientX + window.scrollX, e.clientY + window.scrollY);
});
document.addEventListener('mousemove', (e)=>{
  if(!_tipVisible) return;
  positionTip(e.clientX + window.scrollX, e.clientY + window.scrollY);
});
document.addEventListener('mouseout', (e)=>{
  const from = e.target && e.target.closest ? e.target.closest('.has-tip') : null;
  const to = e.relatedTarget && e.relatedTarget.closest ? e.relatedTarget.closest('.has-tip') : null;
  if(from && from !== to) hideTip();
});

/* Mini toast */
const toast=(msg)=>{
  let el=$('#toast');
  if(!el){ el=document.createElement('div'); el.id='toast'; el.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0e1526;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:10px;z-index:100;opacity:0;transition:.2s;'; document.body.appendChild(el); }
  el.textContent=msg; el.style.opacity='1';
  setTimeout(()=>{ el.style.opacity='0'; }, 1600);
};

/* ===== Indexare ===== */
function buildIndex(){
  const idx = [];
  for (const [item,rec] of Object.entries(DATA)){
    (rec.variants||[]).forEach(v=>{
      idx.push({item, ...v.source, success:v.success ?? null});
    });
  }
  return idx;
}
const INDEX = buildIndex();

/* ===== Index utilizƒÉri (unde e folosit ca ingredient) ===== */
function buildUsesIndex(){
  const uses = {};
  for (const [result, rec] of Object.entries(DATA)){
    (rec.variants || []).forEach(v => {
      for (const [ing, qty] of Object.entries(v.ingredients || {})){
        if (!uses[ing]) uses[ing] = [];
        uses[ing].push({
          result,
          qty,
          source: v.source,
          success: v.success ?? null
        });
      }
    });
  }
  return uses;
}
const USES = buildUsesIndex();

/* >>> TABS actualizate: + Base pentru materiale de bazƒÉ */
const TABS = ['Resource','Crate','Trade','Base'];

/* ===== Stare ===== */
let state={
  currentTab: TABS[0] || 'Resource',
  map: '', npc: '', query:'', qty:1,
  currentItem:'', list:[], selectedVariant:{}
};
// din URL sau localStorage
try{
  if(location.hash.startsWith('#state=')){
    const raw = decodeURIComponent(location.hash.slice(7));
    const parsed = JSON.parse(atob(raw));
    Object.assign(state, parsed);
  } else {
    Object.assign(state, JSON.parse(localStorage.getItem('craft_state_v3')||'{}'));
  }
}catch{}
const saveState=(patch={})=>{
  state = {...state, ...patch};
  localStorage.setItem('craft_state_v3', JSON.stringify(state));
};

/* ===== Helpers ===== */
function mapsForTab(tab){
  return Array.from(new Set(INDEX.filter(r=>r.tab===tab).map(r=>r.map))).sort();
}
function npcsFor(tab,map){
  return Array.from(new Set(INDEX.filter(r=>r.tab===tab && r.map===map).map(r=>r.npc))).sort();
}
function itemsFor(tab,map,npc){
  return Array.from(new Set(
    INDEX
      .filter(r => r.tab === tab && r.map === map && r.npc === npc)
      .map(r => r.item)
  ))
  .filter(name => !DATA[name]?.hidden)
  .sort();
}

/* ===== Arbore re»õete ===== */
function buildTree(name,qty=1,visited=new Set()){
  if(visited.has(name)) return {label:name,qty,loop:true,children:[]};
  visited.add(name);
  const rec=DATA[name];
  if(!rec || !rec.variants || rec.variants.length===0) return {label:name,qty,base:true,children:[]};
  const idx = state.selectedVariant[name] ?? 0;
  const v = rec.variants[idx] || rec.variants[0];
  const node = {label:name,qty,success:v.success,source:v.source,children:[],variantIndex:idx,variantCount:rec.variants.length};
  for(const [ing,q] of Object.entries(v.ingredients||{})){
    node.children.push(buildTree(ing,q*qty,new Set(visited)));
  }
  return node;
}
function countNodes(n){ let c=1; for(const ch of n.children||[]) c+=countNodes(ch); return c; }
function aggregateBaseMaterials(node,totals=new Map()){
  const rec=DATA[node.label];
  if(!rec || !rec.variants || rec.variants.length===0) totals.set(node.label,(totals.get(node.label)||0)+node.qty);
  (node.children||[]).forEach(ch=>aggregateBaseMaterials(ch,totals));
  return totals;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]));
}

/* ===== Overlay imagine detalii ===== */
const imageOverlay = $('#imageOverlay');
const imageOverlayImg = $('#imageOverlayImg');
$('#closeImageOverlay').onclick = ()=> imageOverlay.classList.remove('open');
imageOverlay.addEventListener('click', (e)=>{ if(e.target===imageOverlay) imageOverlay.classList.remove('open'); });
function openImageOverlay(itemName){
  const src = getDetailImageForItem(itemName);
  imageOverlayImg.src = src;
  imageOverlayImg.alt = itemName + ' ‚Äì detalii';
  $('#imageTitle').textContent = itemName;
  imageOverlay.classList.add('open');
  setTimeout(()=>$('#closeImageOverlay').focus(),0);
}

/* ===== Render tree ===== */
function renderTree(node,parent){
  const details=document.createElement('details'); details.open=true;
  const summary=document.createElement('summary'); summary.className='node';
  const label=document.createElement('span'); label.className='label';

  const varBtn = node.variantCount>1 ? `<button class="variantBtn" data-item="${escapeHtml(node.label)}" title="SchimbƒÉ re»õeta" style="margin-left:4px" type="button">üîÑ</button>` : '';
  const iconHtml = `<img loading="lazy" class="item-img openDetail" data-item="${escapeAttr(node.label)}" style="cursor:zoom-in" src="${escapeAttr(getImageForItem(node.label))}" alt="${escapeAttr(node.label)}">`;
  label.innerHTML = `${iconHtml} <strong>${escapeHtml(node.label)}</strong> √ó ${fmtQty(node.qty)} ${(node.success!=null?`<span class="chance">(${node.success}%)</span>`:'')}${varBtn}`;

  const lblImg = label.querySelector('img');
  const lblStrong = label.querySelector('strong');
  attachTooltip(lblImg, node.label);
  attachTooltip(lblStrong, node.label);
  attachTooltip(label, node.label);

  summary.appendChild(label);
  details.appendChild(summary);

  if(node.children && node.children.length){
    node.children.forEach(ch=>renderTree(ch,details));
  }
  parent.appendChild(details);

  if(node.variantCount>1){
    const info = document.createElement('div');
    info.className='muted';
    info.style.cssText='margin-left:32px;font-size:12px';
    info.textContent = `${tr('selected_variant')}: ${node.source.tab} ‚Ä¢ ${node.source.map} ‚Ä¢ ${node.source.npc}`;
    details.appendChild(info);
  }
}

/* ===== Meta & afi»ôare ===== */
function renderMeta(root){
  const meta=$('#meta'); meta.innerHTML='';
  const total=countNodes(root);
  const pill=document.createElement('span'); pill.className='pill'; pill.textContent=`${tr('meta_nodes')}: ${total}`; meta.appendChild(pill);
  const base=aggregateBaseMaterials(root);
  base.forEach((v,k)=>{ const p=document.createElement('span'); p.className='pill'; p.textContent=`${k}: √ó${fmtQty(v)}`; meta.appendChild(p); });
}
function showRecipe(name){
  const qty = parseInt($('#qtyInput').value)||1;
  const root=buildTree(name,qty);
  const tree = $('#tree'); tree.innerHTML='';
  renderTree(root, tree);
  renderMeta(root);
  $('#currentItemName').textContent=`${name} √ó ${fmtQty(qty)}`;
  saveState({currentItem:name, qty});
}

/* ===== Overlay variante ===== */
const overlay=$('#variantOverlay');
const listDiv=$('#variantList');
$('#closeVariantOverlay').onclick=()=>closeOverlay();
function openVariantPanel(item){
  const rec=DATA[item];
  if(!rec || !(rec.variants?.length>1)) return;
  listDiv.innerHTML='';
  $('#variantTitle').textContent = trf('overlayVariantTitleFor', {item});
  rec.variants.forEach((v,i)=>{
    const b=document.createElement('button');
    b.className='primary';
    b.type='button';
    b.textContent=`${v.source.tab} ‚Ä¢ ${v.source.map} ‚Ä¢ ${v.source.npc} (${v.success ?? '?' }%)`;
    b.onclick=()=>{
      state.selectedVariant[item]=i;
      saveState({});
      closeOverlay();
      if(state.currentItem) showRecipe(state.currentItem);
    };
    listDiv.appendChild(b);
  });
  overlay.classList.add('open');
  setTimeout(()=>$('#closeVariantOverlay').focus(),0);
}
function closeOverlay(){ overlay.classList.remove('open'); }
const variantOverlayEl = $('#variantOverlay');
variantOverlayEl.addEventListener('click', (e)=>{ if(e.target===variantOverlayEl) closeOverlay(); });

document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay.classList.contains('open')) closeOverlay(); });

/* ===== Overlay: utilizƒÉri item ===== */
function renderUsesForItem(name){
  const body = $('#usesBody');
  const arr = USES[name] || [];
  $('#usesTitle').textContent = trf('uses_title', {name});
  body.innerHTML = '';

  if (!arr.length){
    body.innerHTML = `<div class="empty">${tr('uses_none')}</div>`;
    return;
  }

  arr.forEach(u => {
    const row = document.createElement('div');
    row.className = 'item';

    const img = document.createElement('img');
    img.className = 'item-img openDetail';
    img.dataset.item = u.result;
    img.style.cursor = 'zoom-in';
    img.alt = u.result;
    img.src = getImageForItem(u.result);
    img.loading = 'lazy';

    const title = document.createElement('div');
    title.className = 'item-title';
    title.innerHTML =
      `<strong>${u.result}</strong>` +
      `<div class="muted">${trf('uses_consumes', {qty: fmtQty(u.qty), name})}</div>` +
      `<div class="muted">${u.source.tab} ‚Ä¢ ${u.source.map} ‚Ä¢ ${u.source.npc}` +
      (u.success != null ? ` ‚Ä¢ ${u.success}%` : '') +
      `</div>`;

    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.style.gap = '6px';

    const seeBtn = document.createElement('button');
    seeBtn.type = 'button';
    seeBtn.className = 'primary';
    seeBtn.textContent = tr('btn_see_recipe');
    seeBtn.title = tr('btn_see_recipe');
    seeBtn.onclick = () => {
      closeUsesPanel();
      $('#qtyInput').value = 1;
      showRecipe(u.result);
    };

    controls.appendChild(seeBtn);

    row.appendChild(img);
    row.appendChild(title);
    row.appendChild(controls);
    body.appendChild(row);
  });
}

function openUsesPanel(name){
  renderUsesForItem(name);
  $('#usesOverlay').classList.add('open');
  setTimeout(() => $('#closeUsesOverlay').focus(), 0);
}
function closeUsesPanel(){
  $('#usesOverlay').classList.remove('open');
}

$('#closeUsesOverlay').onclick = () => closeUsesPanel();
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && $('#usesOverlay').classList.contains('open')) closeUsesPanel();
});
$('#usesOverlay').addEventListener('click', e => {
  if (e.target === $('#usesOverlay')) closeUsesPanel();
});

$('#usesBody').addEventListener('click', (e) => {
  const img = e.target.closest('.openDetail');
  if (!img) return;
  openImageOverlay(img.dataset.item);
});


/* ===== UI st√¢nga ===== */
function renderTabs(){
  const c = $('#tabs'); c.innerHTML='';
  TABS.forEach(tab=>{
    const b=document.createElement('button');
    b.className='tab' + (state.currentTab===tab?' active':'');
    b.setAttribute('role','tab');
    b.setAttribute('aria-selected', state.currentTab===tab ? 'true':'false');
    b.type='button';
    b.textContent=tab;
    b.onclick=()=>{
      state.currentTab=tab;
      const maps = mapsForTab(tab);
      state.map = maps[0] || '';
      const npcs = npcsFor(tab, state.map);
      state.npc = npcs[0] || '';
      saveState({});
      renderTabs(); renderMap(); renderNpc(); renderNpcItems();
    };
    c.appendChild(b);
  });
}
$('#tabs').addEventListener('keydown', (e)=>{
  const tabs = $$('#tabs .tab');
  const i = tabs.findIndex(t=>t === document.activeElement);
  if(i<0) return;
  if(e.key === 'ArrowRight'){ e.preventDefault(); tabs[(i+1)%tabs.length].focus(); }
  if(e.key === 'ArrowLeft'){ e.preventDefault(); tabs[(i-1+tabs.length)%tabs.length].focus(); }
});

function renderMap(){
  const sel = $('#mapSelect'); sel.innerHTML='';
  if (state.currentTab === 'Base') {
    const o=document.createElement('option');
    o.value=''; o.textContent='‚Äî';
    sel.appendChild(o);
    sel.disabled = true;
    return;
  }
  sel.disabled = false;
  const maps = mapsForTab(state.currentTab);
  maps.forEach(m=>{
    const o=document.createElement('option'); o.value=m; o.textContent=m;
    if(m===state.map) o.selected=true;
    sel.appendChild(o);
  });
}
function renderNpc(){
  const sel = $('#npcSelect'); sel.innerHTML='';
  if (state.currentTab === 'Base') {
    const o=document.createElement('option');
    o.value=''; o.textContent='‚Äî';
    sel.appendChild(o);
    sel.disabled = true;
    return;
  }
  sel.disabled = false;
  const npcs = npcsFor(state.currentTab, state.map);
  npcs.forEach(n=>{
    const o=document.createElement('option'); o.value=n; o.textContent=n;
    if(n===state.npc) o.selected=true;
    sel.appendChild(o);
  });
}
function renderNpcItems(){
  const box = $('#npcItems'); box.innerHTML='';
  const search = ($('#searchInput').value||'').trim().toLowerCase();
  let items;

  if (state.currentTab === 'Base') {
    items = Object.entries(DATA)
      .filter(([name, rec]) => !rec.hidden && (!rec.variants || !rec.variants.length))
      .map(([name]) => name)
      .filter(it => it.toLowerCase().includes(search))
      .sort();
  } else {
    items = itemsFor(state.currentTab, state.map, state.npc)
      .filter(it => it.toLowerCase().includes(search));
  }

  updateListCount();

  if(items.length===0){
    box.innerHTML = `<div class="empty">${tr('no_items_current_selection')}</div>`;
    return;
  }
  items.forEach(it=>{
    const row = document.createElement('div');
    row.className='item';

    const img=document.createElement('img');
    img.className='item-img openDetail';
    img.dataset.item = it;
    img.style.cursor = 'zoom-in';
    img.alt = it;
    img.src = getImageForItem(it);
    img.loading = 'lazy';

    const titleWrap=document.createElement('div');
    titleWrap.className='item-title';
    const strong=document.createElement('strong');
    strong.textContent=it;
    const meta=document.createElement('div');
    meta.className='muted';
    meta.textContent = state.currentTab === 'Base'
      ? tr('badge_base_material')
      : `${state.currentTab} ‚Ä¢ ${state.map} ‚Ä¢ ${state.npc}`;
    titleWrap.appendChild(strong);
    titleWrap.appendChild(meta);

    attachTooltip(img, it);
    attachTooltip(strong, it);
    attachTooltip(row, it);

    const seeBtn=document.createElement('button');
    seeBtn.className='primary seeRecipe';
    seeBtn.type='button';
    seeBtn.dataset.item=it;
    seeBtn.textContent=tr('btn_see_recipe');

    const usesBtn=document.createElement('button');
    usesBtn.type='button';
    usesBtn.className='btn small usesBtn';
    usesBtn.dataset.item = it;
    usesBtn.textContent = tr('btn_uses');

    const addBtn=document.createElement('button');
    addBtn.className='addToList';
    addBtn.type='button';
    addBtn.dataset.item=it;
    addBtn.textContent=tr('btn_add');

    const btnCol = document.createElement('div');
    btnCol.style.display = 'flex';
    btnCol.style.flexDirection = 'column';
    btnCol.style.gap = '6px';

    btnCol.appendChild(seeBtn);
    btnCol.appendChild(usesBtn);
    btnCol.appendChild(addBtn);

    row.appendChild(img);
    row.appendChild(titleWrap);
    row.appendChild(btnCol);

    box.appendChild(row);
  });
}

/* ===== Evenimente globale ===== */
$('#mapSelect').addEventListener('change', (e)=>{
  if (state.currentTab === 'Base') return;
  state.map = e.target.value;
  const npcs = npcsFor(state.currentTab, state.map);
  state.npc = npcs[0] || '';
  saveState({});
  renderNpc(); renderNpcItems();
});
$('#npcSelect').addEventListener('change', (e)=>{
  if (state.currentTab === 'Base') return;
  state.npc = e.target.value; saveState({}); renderNpcItems();
});
$('#searchInput').addEventListener('input', debounce(renderNpcItems, 120));
$('#npcItems').addEventListener('click', (e)=>{
  const img = e.target.closest('.openDetail');
  if(img){ openImageOverlay(img.dataset.item); return; }
  const see = e.target.closest('.seeRecipe');
  if(see){ showRecipe(see.dataset.item); return; }
  const uses = e.target.closest('.usesBtn');
  if(uses){ openUsesPanel(uses.dataset.item); return; }
  const add = e.target.closest('.addToList');
  if(add){ addToList(add.dataset.item, parseInt($('#qtyInput').value)||1); }
});

/* ===== Arbore: imagine NU toggl-eazƒÉ <details> ===== */
$('#tree').addEventListener('mousedown', (e)=>{
  if (e.target.closest('.openDetail')) e.preventDefault();
}, true);
$('#tree').addEventListener('touchstart', (e)=>{
  if (e.target.closest('.openDetail')) e.preventDefault();
}, { passive:false, capture:true });
$('#tree').addEventListener('click', (e)=>{
  const img = e.target.closest('.openDetail');
  if (img) {
    e.preventDefault();
    e.stopPropagation();
    openImageOverlay(img.dataset.item);
    return;
  }
  const btn=e.target.closest('.variantBtn');
  if(btn){
    e.preventDefault();
    e.stopPropagation();
    openVariantPanel(btn.dataset.item);
  }
});

/* ===== Controale globale (toolbar / header / listƒÉ) ===== */
$('#expandAll').onclick = () => { $$('#tree details').forEach(d => d.open = true); };
$('#collapseAll').onclick = () => { $$('#tree details').forEach(d => d.open = false); };

$('#addToList').onclick = () => {
  if (!state.currentItem) { toast(tr('select_item_first')); return; }
  const qty = parseInt($('#qtyInput').value) || 1;
  addToList(state.currentItem, qty);
};

$('#exportJson').onclick = () => {
  if (!state.currentItem) { toast(tr('select_item_first')); return; }
  const qty = parseInt($('#qtyInput').value) || 1;
  const data = buildTree(state.currentItem, qty);
  copy(JSON.stringify(data, null, 2));
};

$('#copyLink').onclick = () => {
  const payload = btoa(JSON.stringify(state));
  const url = new URL(window.location.href);
  url.hash = '#state=' + encodeURIComponent(payload);
  copy(url.toString());
};

$('#resetState').onclick = () => {
  localStorage.removeItem('craft_state_v3');
  location.hash = '';
  location.reload();
};

/* ===== CƒÉutare globalƒÉ + autocomplete ===== */
$('#searchGlobal').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const q = e.target.value.trim().toLowerCase();
    if (!q) return;
    const names = Object.keys(DATA).filter(n => n.toLowerCase().includes(q));
    if (names.length) {
      $('#qtyInput').value = 1;
      showRecipe(names[0]);
      $('#tree').focus?.();
    } else {
      toast(tr('search_not_found'));
    }
  }
});

const searchBox = $('#searchGlobal');
const suggBox = $('#searchSuggestions');
let suggIndex = -1;

searchBox.addEventListener('input', () => {
  const val = searchBox.value.trim().toLowerCase();
  if (!val) { suggBox.style.display='none'; return; }
  const matches = Object.keys(DATA).filter(n => n.toLowerCase().includes(val));

  const html = matches.map(name => {
    const info = INDEX.find(i => i.item === name);
    const tip = info ? `${info.tab} ‚Ä¢ ${info.map} ‚Ä¢ ${info.npc}` : 'FƒÉrƒÉ informa»õii';
    const tipEsc = String(tip).replace(/"/g,'&quot;');
    return `<div class="suggest-item" title="${tipEsc}">${name}</div>`;
  }).join('');

  suggBox.innerHTML = html;
  suggBox.style.display = matches.length ? 'block' : 'none';
  suggIndex = -1;
});

suggBox.addEventListener('click', (e) => {
  const item = e.target.closest('.suggest-item')?.textContent;
  if (!item) return;
  searchBox.value = item;
  suggBox.style.display='none';
  $('#qtyInput').value = 1;
  showRecipe(item);
});

searchBox.addEventListener('keydown', (e) => {
  const items = $$('.suggest-item', suggBox);
  if (!items.length) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    suggIndex = (suggIndex + 1) % items.length;
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    suggIndex = (suggIndex - 1 + items.length) % items.length;
  } else if (e.key === 'Enter') {
    if (suggIndex >= 0) {
      e.preventDefault();
      items[suggIndex].click();
    }
    suggBox.style.display='none';
    return;
  } else if (e.key === 'Escape') {
    suggBox.style.display='none';
    return;
  } else return;
  items.forEach((it,i)=>it.classList.toggle('active', i===suggIndex));
});

document.addEventListener('click', (e)=>{
  if(!searchBox.contains(e.target) && !suggBox.contains(e.target)){
    suggBox.style.display='none';
  }
});

$('#openList').addEventListener('click', () => openListPanel());
$('#listCount').addEventListener('click', () => openListPanel());
$('#listCount').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openListPanel(); }
});

$('#qtyInput').addEventListener('input', debounce(() => {
  if (state.currentItem) showRecipe(state.currentItem);
}, 150));

/* ===== ListƒÉ ===== */
function updateListCount(){ $('#listCount').textContent = String(state.list?.reduce((s,i)=>s+i.qty,0) || 0); }
function addToList(name, qty=1){
  if(!name || qty<=0) return;
  if(!Array.isArray(state.list)) state.list=[];
  const found = state.list.find(x=>x.name===name);
  if(found) found.qty += qty; else state.list.push({name, qty});
  saveState({}); updateListCount(); toast(tr('added_to_list'));
}
function removeFromList(name){
  state.list = (state.list||[]).filter(x=>x.name!==name);
  saveState({}); renderListPanel(); updateListCount();
}
function clearList(){ state.list=[]; saveState({}); renderListPanel(); updateListCount(); }
function changeQty(name, delta){
  const it = (state.list||[]).find(x=>x.name===name);
  if(!it) return;
  it.qty = Math.max(1, (it.qty||1) + delta);
  saveState({}); renderListPanel(); updateListCount();
}
function selectFromList(name){
  const it = (state.list||[]).find(x=>x.name===name);
  const q = it ? it.qty : 1;
  closeListPanel();
  $('#qtyInput').value = q;
  showRecipe(name);
  toast(tr('toast_selected_from_list'));
}
function renderListPanel(){
  const body = $('#listBody');
  const items = state.list||[];
  body.innerHTML='';
  if(!items.length){ body.innerHTML = `<div class="empty">${tr('list_empty')}</div>`; return; }
  items.forEach(it=>{
    const row=document.createElement('div'); row.className='item';

    const img=document.createElement('img');
    img.className='item-img openDetail';
    img.dataset.item = it.name;
    img.style.cursor = 'zoom-in';
    img.alt = it.name;
    img.src = getImageForItem(it.name);
    img.loading = 'lazy';

    const title=document.createElement('div'); title.className='item-title';
    title.innerHTML = `<strong>${it.name}</strong><div class="muted">${trf('list_qty_label',{qty: fmtQty(it.qty)})}</div>`;

    const controls=document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px';
    const minus=document.createElement('button'); minus.type='button'; minus.textContent='‚Äì'; minus.title=tr('list_btn_minus_title'); minus.onclick=()=>changeQty(it.name,-1);
    const plus=document.createElement('button'); plus.type='button'; plus.textContent='+'; plus.title=tr('list_btn_plus_title'); plus.onclick=()=>changeQty(it.name,1);
    const choose=document.createElement('button'); choose.type='button'; choose.className='primary'; choose.textContent=tr('btn_choose'); choose.title=tr('list_btn_choose_title'); choose.onclick=()=>selectFromList(it.name);
    const rm=document.createElement('button'); rm.type='button'; rm.textContent=tr('btn_delete'); rm.title=tr('list_btn_delete_title'); rm.onclick=()=>removeFromList(it.name);

    controls.appendChild(minus); controls.appendChild(plus); controls.appendChild(choose); controls.appendChild(rm);

    attachTooltip(img, it.name);
    attachTooltip(title, it.name);
    attachTooltip(row, it.name);

    row.appendChild(img); row.appendChild(title); row.appendChild(controls);
    body.appendChild(row);
  });
}
function openListPanel(){ renderListPanel(); $('#listOverlay').classList.add('open'); setTimeout(()=>$('#closeListOverlay').focus(),0); }
function closeListPanel(){ $('#listOverlay').classList.remove('open'); }
$('#closeListOverlay').onclick=()=>closeListPanel();
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && $('#listOverlay').classList.contains('open')) closeListPanel(); });
$('#listOverlay').addEventListener('click', (e)=>{ if(e.target===$('#listOverlay')) closeListPanel(); });
$('#exportList').onclick=()=> copy(JSON.stringify(state.list||[], null, 2));
$('#clearList').onclick=()=> clearList();

/* ===== Ini»õializare ===== */
function firstOr(v, fallback=''){ return v && v.length ? v[0] : fallback; }
window.addEventListener('load', ()=>{
  if(!TABS.includes(state.currentTab)) state.currentTab = TABS[0] || 'Resource';
  const maps = mapsForTab(state.currentTab);
  if(!maps.includes(state.map)) state.map = firstOr(maps);
  const npcs = npcsFor(state.currentTab, state.map);
  if(!npcs.includes(state.npc)) state.npc = firstOr(npcs);
  saveState({});

  renderTabs(); renderMap(); renderNpc(); renderNpcItems(); updateListCount();

  if(state.currentItem) showRecipe(state.currentItem);

  const langSelect = $('#langSelect');
  if (langSelect){
    langSelect.value = currentLang;
    langSelect.addEventListener('change', (e)=> applyLanguage(e.target.value));
  }
  applyLanguage(currentLang);
});
</script>
</body>
</html>
